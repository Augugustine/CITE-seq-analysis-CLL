---
title: "Pre-processing DDQC"
params: 
  patient: "P1"
  resolution: 0.1
  mito_gene_percent: 10
  directory: "/home/a.blanc-boekholt/Documents/Singlecell-R"
  file: "filtered_feature_bc_matrix.h5"
format: html
editor: visual
---

Steps of this pre-processing, Seurat, DoubletFinder and DDQC (all days merged)

-   Downloading the data filtered by CellBender or 10X Genomics pipeline CellRanger and merging all days into one Seurat object.

-   Removing non-coding genes using **Ensembl** gene annotations (via a reusable custom function).

-   Detecting doublets (Singlet or Doublet) using **DoubletFinder** on each day separately, then adding this metadata to the merged object and removing doublets (also done via a reusable function).

-   Quality control using **DDQC** (Python).

-   Selecting the top 2000 variable genes, normalization, and scaling using **Seurat**.

-   Visualizations: PCA, Heatmap, and UMAP (resolution 0.1)

## Data and libraries initialization

```{r}
#| message: false
library(SeuratObject)
library(sp)
library(Seurat)
library(hdf5r)
library(dplyr)
library(patchwork)
#library(scDblFinder)
library(DoubletFinder)
#library(SingleCellExperiment)
library(tibble)
library(biomaRt)
library(ggplot2)
library(ddqcR)
source("functions.R")
```

```{r}
#| include: false
seurat <- load_data(params$patient, c(1,4,8,11,14), params$directory, params$file)
list2env(seurat, envir = .GlobalEnv)
```

Add an identity with the time point

```{r}
CLL_D1_filtered$timepoint <- "D1"
CLL_D4_filtered$timepoint <- "D4"
CLL_D8_filtered$timepoint <- "D8"
CLL_D11_filtered$timepoint <- "D11"
CLL_D14_filtered$timepoint <- "D14"
```

Merge all the data filtered, in order to have one SeuratObject with all the time point for one patient (and the total cells and genes number).

```{r}
CLL_merged <- merge(CLL_D1_filtered, y = list(CLL_D4_filtered, CLL_D8_filtered,
                                                    CLL_D11_filtered, CLL_D14_filtered),
                       add.cell.ids = c("D1", "D4", "D8", "D11", "D14"), project = "TimeCourse")

CLL_merged[["RNA"]] <- JoinLayers(CLL_merged[["RNA"]])
```

Total number of cells at the beginning.

```{r}
ncol(CLL_merged)
```

## Non coding genes removal

Features number before non-coding genes removal

```{r}
nrow(CLL_merged)
```

The non-coding genes removal is based on the database Ensembl in order to select the genes coding for proteins. The function used is explain on the file functions.R

This function accepts a Seurat object at any stage (pre- or post-processing) and returns a version of the object with all non-coding genes filtered out.

```{r}
CLL_merged <- removal_noncoding_gene(CLL_merged)
```

Features number after non-coding genes removal

```{r}
nrow(CLL_merged)
```

## Doublet removal

Number of cell before doublet removal

```{r}
ncol(CLL_merged)
```

The tool used is DoubletFinder, and it is important to run it on each sample individually rather than on aggregated data. The input for this step is a Seurat object corresponding to one sample (i.e., one patient at one time point). In this case, we use the custom function `complete_DoubletFinder` defined in the `functions.R` file. This function performs all necessary preprocessing steps prior to running DoubletFinder. The output is a data frame where each row corresponds to a cell ID, and the column indicates whether the cell is classified as a singlet or doublet.

```{r}
#| message: false
#| warning: false
#| include: false
res.D1<-complete_DoubletFinder(CLL_D1_filtered)
res.D1$row_names <- paste0("D1_", res.D1$row_names)
res.D4<-complete_DoubletFinder(CLL_D4_filtered)
res.D4$row_names <- paste0("D4_", res.D4$row_names)
res.D8<-complete_DoubletFinder(CLL_D8_filtered)
res.D8$row_names <- paste0("D8_", res.D8$row_names)
res.D11<-complete_DoubletFinder(CLL_D11_filtered)
res.D11$row_names <- paste0("D11_", res.D11$row_names)
res.D14<-complete_DoubletFinder(CLL_D14_filtered)
res.D14$row_names <- paste0("D14_", res.D14$row_names)
results_multiplet <-bind_rows(res.D1, res.D4, res.D8, res.D11, res.D14)
rownames(results_multiplet) <- results_multiplet$row_names
results_multiplet$row_names <- NULL
```

Doublet/Singlet class addition in the Seurat Object metadata and removal doublet

```{r}
CLL_merged <- AddMetaData(CLL_merged, results_multiplet)
CLL_merged <- subset(CLL_merged, doublet_finder == 'Singlet')
```

Cell number after doublets removal

```{r}
ncol(CLL_merged)
```

## QC and filtering

This step in done on the data days merged (same threshold for the 5 time points). The tool DDQC is a tool used for the quality control in single cell RNA seq. It identifies and filters the bad quality cells thanks to adaptive threshold based on the median absolute deviation on four QC metrics (gene and UMI complexity, fraction of reads mapping to mitochondrial and ribosomal genes) on clusters. (Subramanian, A., Alperovich, M., Yang, Y. *et al.*, 2022).

Mitochondrial and ribosomal genes percentage

```{r}
CLL_merged[["percent.mt"]] <- PercentageFeatureSet(CLL_merged, pattern = "^MT-")
CLL_merged[["percent.ribo"]] <- PercentageFeatureSet(CLL_merged, pattern = "^RPS|^RPL")
```

```{r}
ddqc_results<- ddqc.metrics(CLL_merged, res= 0.1)
```

Metadata extraction and adding to the Seurat Object

```{r}
ddqc_metadata <- as.data.frame(colData(ddqc_results)[, c("passed.qc")])

CLL_merged <- AddMetaData(CLL_merged, metadata = ddqc_metadata)
```

Filtering

```{r}
CLL_merged <- subset(CLL_merged, subset = passed.qc==TRUE)
```
