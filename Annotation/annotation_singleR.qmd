---
title: "Annotation SingleR"
params: 
  patient: "P1"
  file: "CLL_P1_seurat_reduit.rds"
  type: "DDQC"
format: html
editor: visual
---

Automatic annotation with SingleR. This script use Seurat 5.3.0 and SingleR 2.11.3.

## Data and libraries initialization

```{r}
#| message: false
library(SeuratObject)
library(sp)
library(Seurat)
library(hdf5r)
library(dplyr)
library(patchwork)
library(ggplot2)
library(Azimuth)
#library(vegan)
library(SingleR)
library(celldex)
library(stringr)
source("functions.R")
```

Read the data pre-processed

```{r}
data<-readRDS(params$file)
```

### SingleR

Get reference dataset and the count matrix

```{r}
ref <- celldex::HumanPrimaryCellAtlasData()
norm_counts <- LayerData(data, assay = "RNA", layer = 'data')
```

Subset to include only relevant cell types

```{r}
ref <- ref[,grepl('DC|B_cell|Neutrophils|T_cells|Monocyte|Erythroblast|
                 Macrophage|NK_cell|Platelets|Myelocyte', ref$label.main)]
unique(ref$label.main)
```

```{r}
annotation<-SingleR(test = norm_counts,
                  ref = ref, 
                  labels = ref$label.main,
                  de.method = 'wilcox')
```

Add to seurat object

```{r}
data_annotated <- AddMetaData(data, annotation$pruned.labels, col.name = 'SingleR')
```

## Visualization

UMAP

```{r}
title=paste("UMAP annotated by SingleR, pre-processing type :", params$type, ", patient", params$patient)
plotumap<-DimPlot(data_annotated, group.by="SingleR", group.by="SingleR", reduction = "umap") + ggtitle(str_wrap(title, width = 50)) + theme(plot.title = element_text(size = 10, hjust = 0.5))
plotumap
ggsave(paste0(params$type,"_umap_SingleR_", params$patient, ".jpeg"), plotumap)
```

UMAP by timepoint

```{r}
data_annotated$timepoint <- factor(
  data_annotated$timepoint,
  levels = c("D1", "D4", "D8", "D11", "D14")
)
title=paste("UMAP annotated by SingleR by timepoint, pre-processing type :", params$type, ", patient", params$patient)
plot1<-DimPlot(data_annotated, group.by="SingleR", reduction = "umap", split.by = "timepoint") + ggtitle(str_wrap(title, width = 50)) + theme(plot.title = element_text(size = 10, hjust = 0.5))
plot1
ggsave(paste0(params$type, "_umap_timepoint_SingleR_", params$patient, ".jpeg"), plot1)
```

wnnUMAP

```{r}
#| message: false
#| warning: false
data_annotated <-run_adt_umap(data_annotated)
title=paste("wnnUMAP annotated by SingleR, pre-processing type :", params$type, ", patient", params$patient)
plotwnn <- DimPlot(data_annotated, group.by="SingleR", reduction = 'wnn.umap', label = TRUE, repel = TRUE, label.size = 2.5) + 
  NoLegend() + ggtitle(str_wrap(title, width = 50)) + theme(plot.title = element_text(size = 10, hjust = 0.5))
plotwnn
ggsave(paste0(params$type,"_wnnumap_SingleR_", params$patient, ".jpeg"), plotwnn)
DefaultAssay(data_annotated) <- 'RNA'
```

t-SNE

```{r}
title=paste("t-SNE annotated by SingleR, pre-processing type :", params$type, ", patient", params$patient)
plot1<-DimPlot(data_annotated, group.by="SingleR", reduction = 'tsne', label = TRUE, repel = TRUE, label.size = 2.5) + ggtitle(str_wrap(title, width = 50)) + theme(plot.title = element_text(size = 10, hjust = 0.5))
plot1
ggsave(paste0(params$type,"_tsne_SingleR_", params$patient, ".jpeg"), plot1)
```

Bonsai

In this analysis, we use the single-cell Bonsai pipeline available at <https://bonsai.unibas.ch/bonsai/>. The TSV matrix is exported in the pre-processing script, and we supplemented it with an annotation TSV file containing cell barcodes and their corresponding cell type annotations.

```{r}
barcodes <- colnames(annotation)
annotations <- annotation$pruned.labels

df <- data.frame(
  barcode = barcodes,
  predicted_celltype = annotations
)
namefile=paste0("singler_annotation_", params$type, "_", params$patient, ".tsv")
write.table(df, file = namefile, sep = "\t", row.names = FALSE, quote = FALSE)
```

Isomap

```{r}
pc_mat <- Embeddings(data_annotated, reduction = "pca")[, 1:10]

iso <- isomap(dist(pc_mat), ndim = 2, k = 10)  # k = nb voisins, Ã  ajuster

# Add Isomap reduction in the Seurat Object 
data_annotated[["isomap"]] <- CreateDimReducObject(
  embeddings = iso$points,
  key = "ISO_",
  assay = DefaultAssay(data)
)

title=paste("Isomap annotated by SingleR, pre-processing type :", params$type, ", patient", params$patient)
DimPlot(data_annotated, group.by="SingleR", reduction = "isomap") + ggtitle(str_wrap(title, width = 50)) + theme(plot.title = element_text(size = 10, hjust = 0.5))
```

## Save the annotation file

```{r}
namepath=paste0("CLL_singleR_annotated_", params$type, "_", params$patient, ".rds")
saveRDS(data_annotated, file = namepath)
```
