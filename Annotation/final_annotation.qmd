---
title: "Final annotation"
params: 
  patient: "P2"
  file: "CLL_manual_annotated_valiDrops_P2.rds"
  type: "valiDrops"
format: html
editor: visual
---

## Data and libraries initialization

```{r}
#| message: false
library(SeuratObject)
library(sp)
library(Seurat)
library(hdf5r)
library(dplyr)
library(patchwork)
library(ggplot2)
library(stringr)
source("functions.R")
```

Read the data pre-processed

```{r}
data<-readRDS(params$file)
```

## Final annotation

We compared the cell type annotations obtained from the three methods, Azimuth, SingleR and manual. If both methods or 2/3 assigned the same cell type to a given cluster, this annotation was accepted. In cases where the annotations differed, the cell type was determined based on manual annotation.

Consensus between the 3 annotations

```{r}
meta <- data@meta.data
final_annot <- mapply(final_consensus, meta$SingleR, meta$manual_annotation, meta$predicted.celltype.l2)
names(final_annot) <- colnames(data)
data$final_annot <- final_annot
```

```{r}
title=paste("UMAP annotated, pre-processing type :", params$type, ", patient", params$patient)
cell_palette <- c(
  "CD4 T" = "#1f77b4",
  "CD8 T" = "#2ca02c",
  "NK" = "#e7298a",
  "B naive" = "#ff7f0e",
  "B intermediate" = "#ffd92f",
  "B memory" = "#582d15ff",
  "Monocyte" = "#e41a1c",
  "Macrophage" = "#984ea3",
  "DC" = "#4daf4a",
  "Neutrophil" = "#377eb8",
  "Platelet" = "#999999",
  "Erythroblast" = "#17becf",
  "Plasmablast" = "#fdbf6f",
  "HSPC" = "#6a3d9a",
  "B" = "#f2a890ff",
  "T" = "#93f290ff")
plot <- DimPlot(data, group.by="final_annot", reduction = 'umap', label = TRUE, repel = TRUE, label.size = 4, cols = cell_palette) + ggtitle(str_wrap(title, width = 100)) + theme(plot.title = element_text(size = 13, hjust = 0.5), legend.text = element_text(size =12 ))
plot
ggsave(paste0(params$type,"_umap_annotated_", params$patient, ".jpeg"), plot, width = 3000, height = 2000, units = "px")
```

```{r}
table(data$SingleR)
table(data$predicted.celltype.l2)
table(data$manual_annotation)
table(data$final_annot)
```

t-SNE

```{r}
title=paste("t-SNE annotated, pre-processing type :", params$type, ", patient", params$patient)
plot1<-DimPlot(data, group.by="final_annot", reduction = 'tsne', label = TRUE, , cols = cell_palette, repel = TRUE, label.size = 4) + ggtitle(str_wrap(title, width = 90)) + theme(plot.title = element_text(size = 13, hjust = 0.5), legend.text = element_text(size =12 ))
plot1
ggsave(paste0(params$type,"_tsne_annotated_", params$patient, ".jpeg"), plot1, width = 3000, height = 2000, units = "px")
```

Bonsai

In this analysis, we use the single-cell Bonsai pipeline available at <https://bonsai.unibas.ch/bonsai/>. The TSV matrix is exported in the pre-processing script, and we supplemented it with an annotation TSV file containing cell barcodes and their corresponding cell type annotations.

```{r}
barcodes <- colnames(data)
annotations <- data$final_annot

df <- data.frame(
  barcode = barcodes,
  predicted_celltype = annotations
)
namefile=paste0("annotation_", params$type, "_", params$patient, ".tsv")
write.table(df, file = namefile, sep = "\t", row.names = FALSE, quote = FALSE)
```

## Save the annotation file

```{r}
namepath=paste0("CLL_annotated_", params$type, "_", params$patient, ".rds")
saveRDS(data, file = namepath)
```
