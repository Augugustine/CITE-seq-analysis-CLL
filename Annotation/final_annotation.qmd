---
title: "Final annotation"
params: 
  patient: "P2"
  file: "CLL_P1_seurat_reduit.rds"
  type: "Seurat LogNormalize"
format: html
editor: visual
---

## Data and libraries initialization

```{r}
#| message: false
library(SeuratObject)
library(sp)
library(Seurat)
library(hdf5r)
library(dplyr)
library(patchwork)
library(ggplot2)
library(stringr)
source("functions.R")
```

Read the data pre-processed

```{r}
data<-readRDS(params$file)
```

## Final annotation

It combines both automatic and manual annotation approaches to improve accuracy and biological relevance. The input Seurat object needs to be annotated by Azimuth, SingleR and manual annotation. (Scritps `automatic_annotation.qmd` and `manual_annotation.qmd`)

This code integrates three sources of single-cell annotations (SingleR, Azimuth, and manual) into a final consensus label. First, cell type names are harmonized so that equivalent terms (e.g. *B_cell*, *B cell*, *B*) are standardized. Then, for each cell, a consensus function is applied: if two or more methods agree, that label is kept; if the consensus is broad (*T* or *B*), but one source provides a more specific subtype (e.g. *CD4 T* vs *T*), the more granular label is retained. If there is no agreement across the three sources, the cell is annotated as *Unknown*. The final labels are stored in the Seurat object under `final_annot` and can be visualized on a UMAP plot.

Consensus between the 3 annotations

```{r}
data$SingleR_clean <- name_norm(data$SingleR)
data$Manual_clean <- name_norm(data$manual_annotation)
data$Azimuth_clean  <- name_norm(data$predicted.celltype.l1)
```

```{r}
final <- mapply(consensus, data$SingleR_clean, data$Manual_clean, data$Azimuth_clean)
data$final_annot <- final
```

```{r}
title=paste("UMAP annotated, pre-processing type :", params$type, ", patient", params$patient)
plot <- DimPlot(data, reduction = 'umap', label = TRUE, repel = TRUE, label.size = 4) + ggtitle(str_wrap(title, width = 100)) + theme(plot.title = element_text(size = 13, hjust = 0.5), legend.text = element_text(size =12 ))
plot
ggsave(paste0(params$type,"_annotated_", params$patient, ".jpeg"), plot, width = 3000, height = 2000, units = "px")
```

```{r}
#table(data_annotated$SingleR)
#table(data_annotated$Azimuth)
```
