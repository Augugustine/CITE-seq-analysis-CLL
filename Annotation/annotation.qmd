---
title: "Annotation"
params: 
  patient: "P1"
  file: "CLL_P1_seurat.rds"
  pre-pro_type: "DDQC"
format: html
editor: visual
---

# Cell types annotation

This script aims to annotate cell clusters in order to identify the corresponding cell types. It combines both automatic and manual annotation approaches to improve accuracy and biological relevance.

## Data and libraries initialization

```{r}
#| message: false
library(SeuratObject)
library(sp)
library(Seurat)
library(hdf5r)
library(dplyr)
library(patchwork)
library(ggplot2)
library(Azimuth)
#library(vegan)
library(SingleR)
library(celldex)
source("functions.R")
```

Read the data pre-processed

```{r}
data<-readRDS(params$file)
```

## Manual annotation

With WebCSEA and Seurat

```{r}
cluster6.markers <- FindMarkers(data, ident.1 = 6, ident.2 = c(0, 1, 2, 3, 4, 5))
```

```{r}
cluster6.markers <- FindMarkers(data, ident.1 = 6, logfc.threshold = 0.25, test.use = "roc", only.pos = TRUE)
```

```{r}
VlnPlot(data, features = c("MS4A1", "CD79A"))
```

```{r}
FeaturePlot(data, features = c("MS4A1", "GNLY", "CD3E", "CD14", "FCER1A", "FCGR3A", "LYZ", "PPBP",
    "CD8A"))
```

Extraction des marqueurs différencitiellement exprimés puis injectuon de ces mraqueurs l'outil WebCSEA (Dai Y, Hu R, Liu A, Cho KS, Manuel AM, Li X, Dong X, Jia P, Zhao Z, 2022).

```{r}
new.cluster.ids <- c("Naive CD4 T", "CD14+ Mono", "Memory CD4 T", "B", "CD8 T", "FCGR3A+ Mono",
    "NK", "DC", "Platelet")
names(new.cluster.ids) <- levels(data)
data <- RenameIdents(data, new.cluster.ids)
DimPlot(data, reduction = "umap", label = TRUE, pt.size = 0.5) + NoLegend()
```

```{r}
plot <- DimPlot(data, reduction = "umap", label = TRUE, label.size = 4.5) + xlab("UMAP 1") + ylab("UMAP 2") +
    theme(axis.title = element_text(size = 18), legend.text = element_text(size = 18)) + guides(colour = guide_legend(override.aes = list(size = 10)))
ggsave(filename = "./Plots/umap_annotated.jpg", height = 7, width = 12, plot = plot, quality = 50)
```

```{r}
saveRDS(data, file = "CLL_annoted.rds")
```

Visualization (graphs)

```{r}
DimPlot(data, reduction = "umap", group.by = ) + ggtitle()
```

In Bonsai tool we can add a file with the cell annotation. The file required is a tsv file with in column the cell barcodes and the cell type.

```{r}
annotation_column <- "seurat_clusters"  # column name : to change
barcode_annotation <- data.frame(
  barcode = colnames(data),
  annotation = data@meta.data[[annotation_column]]
)
write.table(annotation, file = "barcode_annotation.tsv", sep = "\t", quote = FALSE, col.names = NA)
```

## Automatic annotation

### Azimuth

Retrieve the Seurat object (containing both RNA and ADT data), but perform cell type annotation using only the RNA modality. The object must already be filtered (cells and genes), and must contain raw RNA counts, as Azimuth will apply its own normalization consistent with the reference dataset used (Hao et al., 2021).

```{r}
#InstallData("pbmcref")
data <- RunAzimuth(data, reference = "pbmcref")
```

```{r}
title=paste("UMAP annotated, pre-processing type :", params$pre-pro_type, ", patient", params$patient)
DimPlot(data, group.by = "predicted.celltype.l1", label = TRUE, label.size = 3) + ggtitle(str_wrap(title, width = 80)) + theme(plot.title = element_text(size = 10, hjust = 0.5))
```

check the score prediction

### SingleR

Get reference dataset and the count matrix

```{r}
ref <- celldex::HumanPrimaryCellAtlasData()
norm_counts <- LayerData(data, assay = "RNA", layer = 'data')
```

Subset to include only relevant cell types

```{r}
ref <- ref[,grepl('DC|B_cell|Neutrophils|T_cells|Monocyte|Erythroblast|
                 Macrophage|NK_cell|Platelets|Myelocyte', ref$label.main)]
unique(ref$label.main)
```

```{r}
annotation<-SingleR(test = norm_counts,
                  ref = ref, 
                  labels = ref$label.main,
                  de.method = 'wilcox')
```

Add to seurat object

```{r}
data_annotated <- AddMetaData(data, annotation$pruned.labels, col.name = 'SingleR')

# Visualise them on the UMAP
data_annotated <- SetIdent(data_annotated, value = "SingleR")
DimPlot(data_annotated, label = T , repel = T, label.size = 3) + NoLegend()

```

Checker les ADT pour confirmer les cell types

## Visualization

UMAP

```{r}
title=paste("UMAP annotated, pre-processing type :", params$pre-pro_type, ", patient", params$patient)
DimPlot(data, reduction = "umap")
plotumap<-DimPlot(data, reduction = "umap") + ggtitle(str_wrap(title, width = 80)) + theme(plot.title = element_text(size = 10, hjust = 0.5))
ggsave(paste0(params$pre-pro_type,"_umap_annoted", params$patient, ".jpeg"), plotumap)
```

UMAP by timepoint

```{r}
data$timepoint <- factor(
  data$timepoint,
  levels = c("D1", "D4", "D8", "D11", "D14")
)
title=paste("UMAP annotated by timepoint, pre-processing type :", params$pre-pro_type, ", patient", params$patient)
plot1<-DimPlot(data, reduction = "umap", group.by = "???", split.by = "timepoint") + ggtitle(str_wrap(title, width = 80)) + theme(plot.title = element_text(size = 10, hjust = 0.5))
plot1
ggsave(paste0(params$pre-pro_type, "_umap_timepoint_", params$patient, ".jpeg"), plot1)
```

wnnUMAP

```{r}
#| message: false
#| warning: false
data <-run_adt_umap(data)
title=paste("wnnUMAP annotated, pre-processing type :", params$pre-pro_type, ", patient", params$patient)
plotwnn <- DimPlot(data, reduction = 'wnn.umap', label = TRUE, repel = TRUE, label.size = 2.5) + 
  NoLegend() + ggtitle(str_wrap(title, width = 80)) + theme(plot.title = element_text(size = 10, hjust = 0.5))
plotwnn
ggsave(paste0(params$pre-pro_type,"_wnnumap_", params$patient, ".jpeg"), plotwnn)
DefaultAssay(data) <- 'RNA'
```

t-SNE

```{r}
title=paste("t-SNE annotated, pre-processing type :", params$pre-pro_type, ", patient", params$patient)
plot1<-TSNEPlot(data) + ggtitle(str_wrap(title, width = 80)) + theme(plot.title = element_text(size = 10, hjust = 0.5))
plot1
ggsave(paste0(params$pre-pro_type,"_tsne_", params$patient, ".jpeg"), plot1)
```

Bonsai

In this analysis, we use the single-cell Bonsai pipeline available at <https://bonsai.unibas.ch/bonsai/>. The TSV matrix is exported in the pre-processing script, and we supplemented it with an annotation TSV file containing cell barcodes and their corresponding cell type annotations.

```{r}

```

Isomap

```{r}
pc_mat <- Embeddings(data, reduction = "pca")[, 1:10]

iso <- isomap(dist(pc_mat), ndim = 2, k = 10)  # k = nb voisins, à ajuster

# Add Isomap reduction in the Seurat Object 
data[["isomap"]] <- CreateDimReducObject(
  embeddings = iso$points,
  key = "ISO_",
  assay = DefaultAssay(data)
)

title=paste("Isomap annotated, pre-processing type :", params$pre-pro_type, ", patient", params$patient)
DimPlot(data, reduction = "isomap") + ggtitle(str_wrap(title, width = 80)) + theme(plot.title = element_text(size = 10, hjust = 0.5))
```

## Focus on monocytes, macrophages and CLL cells (B cells)
