---
title: "Annotation Azimuth"
params: 
  patient: "P1"
  file: "CLL_P1_seurat_reduit.rds"
  type: "DDQC"
format: html
editor: visual
---

Automatic annotation with Azimuth. This script and Azimuth needs Seurat 5.2.1.

```{r}
#renv::remove("Seurat")
#devtools::install_github("satijalab/seurat", ref = "v5.2.1")
```

## Data and libraries initialization

```{r}
#| message: false
library(SeuratObject)
library(sp)
library(Seurat)
library(hdf5r)
library(dplyr)
library(patchwork)
library(ggplot2)
library(Azimuth)
library(stringr)
library(SeuratData)
library(celldex)
source("functions.R")
```

Read the data pre-processed

```{r}
data<-readRDS(params$file)
```

### Azimuth

Retrieve the Seurat object (containing both RNA and ADT data), but perform cell type annotation using only the RNA modality. The object must already be filtered (cells and genes), and must contain raw RNA counts, as Azimuth will apply its own normalization consistent with the reference dataset used (Hao et al., 2021).

```{r}
#InstallData("pbmcref")
```

```{r}
#| include: false
data_annotated <- RunAzimuth(data, reference = "pbmcref")

colnames(data_annotated@meta.data)[
  colnames(data_annotated@meta.data) == "predicted.celltype.l1"
] <- "Azimuth.pbmc.l1"

colnames(data_annotated@meta.data)[
  colnames(data_annotated@meta.data) == "predicted.celltype.l2"
] <- "Azimuth.pbmc.l2"

colnames(data_annotated@meta.data)[
  colnames(data_annotated@meta.data) == "predicted.celltype.l3"
] <- "Azimuth.pbmc.l3"
```

## Visualization

UMAP

```{r}
title=paste("UMAP annotated by Azimuth (pbmc reference), pre-processing type :", params$type, ", patient", params$patient)
plotumap<-DimPlot(data_annotated, group.by = "Azimuth.pbmc.l1", reduction = "umap", label = TRUE, repel = TRUE, label.size = 2.5) + ggtitle(str_wrap(title, width = 50)) + theme(plot.title = element_text(size = 10, hjust = 0.5))
plotumap
ggsave(paste0(params$type,"_umap_Azimuthpbmc_", params$patient, ".jpeg"), plotumap)
```

wnnUMAP

```{r}
#| message: false
#| warning: false
data_annotated <-run_adt_umap(data_annotated)
title=paste("wnnUMAP annotated by Azimuth, pre-processing type :", params$type, ", patient", params$patient)
plotwnn <- DimPlot(data_annotated, group.by = "predicted.celltype.l1", reduction = 'wnn.umap', label = TRUE, repel = TRUE, label.size = 2.5) + 
  NoLegend() + ggtitle(str_wrap(title, width = 50)) + theme(plot.title = element_text(size = 10, hjust = 0.5))
plotwnn
ggsave(paste0(params$type,"_wnnumap_Azimuth_", params$patient, ".jpeg"), plotwnn)
DefaultAssay(data_annotated) <- 'RNA'
```

t-SNE

```{r}
title=paste("t-SNE annotated by Azimuth, pre-processing type :", params$type, ", patient", params$patient)
plot1<-DimPlot(data_annotated, group.by="predicted.celltype.l1", reduction = 'tsne', label = TRUE, repel = TRUE, label.size = 2.5) + ggtitle(str_wrap(title, width = 50)) + theme(plot.title = element_text(size = 10, hjust = 0.5))
plot1
ggsave(paste0(params$type,"_tsne_Azimuth_", params$patient, ".jpeg"), plot1)
```

Bonsai

In this analysis, we use the single-cell Bonsai pipeline available at <https://bonsai.unibas.ch/bonsai/>. The TSV matrix is exported in the pre-processing script, and we supplemented it with an annotation TSV file containing cell barcodes and their corresponding cell type annotations.

```{r}
barcodes <- colnames(data_annotated)
annotations <- data_annotated$predicted.celltype.l1

df <- data.frame(
  barcode = barcodes,
  predicted_celltype = annotations
)
namefile=paste0("azimuth_annotation_", params$type, "_", params$patient, ".tsv")
write.table(df, file = namefile, sep = "\t", row.names = FALSE, quote = FALSE)
```

## Save the annotation file

```{r}
namepath=paste0("CLL_azimuth_annotated_", params$type, "_", params$patient, ".rds")
saveRDS(data_annotated, file = namepath)
```
